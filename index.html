<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniCalc Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
            colors: {
              calculator: {
                bg: '#1e1e2e',
                surface: '#262639',
                display: '#181825',
                accent: '#89b4fa',
                operator: '#f38ba8',
                function: '#cba6f7',
                text: '#cdd6f4',
                secondaryText: '#a6adc8',
              }
            }
          },
        },
      }
    </script>

    <!-- Custom Styles -->
    <style>
      /* Custom scrollbar for history panel */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #181825; 
      }
      ::-webkit-scrollbar-thumb {
        background: #45475a; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #585b70; 
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>

    <!-- Dependencies -->
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- MathJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.0/math.js"></script>
    
    <!-- Babel (for compiling JSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "mathjs": "https://aistudiocdn.com/mathjs@^15.1.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
  }
}
</script>
</head>
<body class="bg-calculator-bg text-calculator-text antialiased h-screen overflow-hidden selection:bg-calculator-accent selection:text-calculator-bg">
    
    <div id="root"></div>

    <script type="text/babel">
        // --- UTILITIES (mathUtils.ts) ---
        
        // Configure mathjs
        if (window.math) {
            window.math.config({
                number: 'BigNumber',
                precision: 64,
            });
        }

        const evaluateExpression = (expression) => {
            try {
                if (!window.math) return "Error";

                // Basic sanitization
                let sanitized = expression
                    .replace(/×/g, '*')
                    .replace(/÷/g, '/')
                    .replace(/π/g, 'pi')
                    .replace(/√\(/g, 'sqrt(')
                    .replace(/log\(/g, 'log10(') // Map UI 'log' to log10
                    .replace(/ln\(/g, 'log(');   // Map UI 'ln' to natural log

                const result = window.math.evaluate(sanitized);

                if (typeof result === 'number' || (result && result.isBigNumber)) {
                    return window.math.format(result, { precision: 14 });
                }
                return String(result);
            } catch (error) {
                console.error("Math evaluation error:", error);
                return "Error";
            }
        };

        const generateId = () => {
            return Math.random().toString(36).substring(2, 9);
        };

        const CalculatorMode = {
            BASIC: 'BASIC',
            SCIENTIFIC: 'SCIENTIFIC'
        };

        // --- ICONS (SVG Components) ---
        
        const IconHistory = ({size=24, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l4 2"/></svg>
        );

        const IconCalculator = ({size=24, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>
        );

        const IconFlask = ({size=24, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>
        );

        const IconTrash = ({size=24, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
        );

        const IconCopy = ({size=24, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
        );

        const IconDownload = ({size=24, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
        );

        const IconX = ({size=24, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );
        
        const IconDelete = ({size=24, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 5H9l-7 7 7 7h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Z"/><line x1="18" x2="12" y1="9" y2="15"/><line x1="12" x2="18" y1="9" y2="15"/></svg>
        );


        // --- COMPONENTS ---

        // Button.tsx
        const Button = ({ 
            label, 
            onClick, 
            variant = 'default', 
            className = '',
            disabled = false,
            title = ''
        }) => {
            
            const baseStyles = "relative overflow-hidden rounded-xl text-lg font-medium transition-all duration-200 active:scale-95 flex items-center justify-center select-none disabled:opacity-50 disabled:active:scale-100";
            
            const variants = {
                default: "bg-calculator-surface text-calculator-text hover:bg-[#313244] hover:text-white shadow-sm border border-white/5",
                operator: "bg-calculator-surface text-calculator-operator hover:bg-[#313244] hover:text-pink-300 shadow-sm border border-white/5 font-bold text-2xl",
                function: "bg-calculator-surface text-calculator-function hover:bg-[#313244] hover:text-violet-300 text-sm md:text-base font-semibold border border-white/5",
                accent: "bg-calculator-accent text-calculator-bg hover:brightness-110 font-bold shadow-md shadow-calculator-accent/20",
                danger: "bg-red-500/10 text-red-400 hover:bg-red-500/20 border border-red-500/20",
            };

            return (
                <button
                className={`${baseStyles} ${variants[variant]} ${className}`}
                onClick={onClick}
                disabled={disabled}
                type="button"
                title={title}
                >
                {label}
                </button>
            );
        };

        // Display.tsx
        const Display = ({ input, result, isError }) => {
            const scrollRef = React.useRef(null);

            React.useEffect(() => {
                if (scrollRef.current) {
                scrollRef.current.scrollLeft = scrollRef.current.scrollWidth;
                }
            }, [input]);

            return (
                <div className="flex flex-col items-end justify-end w-full h-32 md:h-40 bg-calculator-display rounded-2xl p-6 mb-4 shadow-inner border border-white/5 relative overflow-hidden group">
                    <div className="absolute -top-10 -left-10 w-32 h-32 bg-calculator-accent/5 rounded-full blur-3xl group-hover:bg-calculator-accent/10 transition-colors duration-500 pointer-events-none"></div>

                    <div 
                        ref={scrollRef}
                        className="w-full overflow-x-auto overflow-y-hidden no-scrollbar whitespace-nowrap text-right scroll-smooth"
                    >
                        <span className={`text-3xl md:text-5xl font-mono tracking-tight ${input ? 'text-calculator-text' : 'text-calculator-secondaryText/50'}`}>
                        {input || '0'}
                        </span>
                    </div>

                    <div className="mt-2 h-8 w-full text-right overflow-hidden">
                        <span className={`text-xl md:text-2xl font-medium transition-colors duration-300 ${isError ? 'text-red-400' : 'text-calculator-secondaryText'}`}>
                        {result && !isError ? `= ${result}` : isError ? 'Error' : ''}
                        </span>
                    </div>
                </div>
            );
        };

        // HistoryPanel.tsx
        const HistoryPanel = ({
            isOpen,
            onClose,
            history,
            onSelectHistory,
            onClearHistory,
        }) => {
            
            const handleCopy = (e, text) => {
                e.stopPropagation();
                navigator.clipboard.writeText(text);
            };

            const handleExport = () => {
                if (history.length === 0) return;
                
                const csvContent = "data:text/csv;charset=utf-8," 
                + "Timestamp,Expression,Result\n"
                + history.map(h => `${new Date(h.timestamp).toISOString()},"${h.expression}",${h.result}`).join("\n");

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "calculator_history.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <React.Fragment>
                <div 
                    className={`fixed inset-0 bg-black/50 backdrop-blur-sm z-40 transition-opacity duration-300 md:hidden ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
                    onClick={onClose}
                />

                <div className={`fixed top-0 right-0 h-full w-80 bg-calculator-surface shadow-2xl z-50 transform transition-transform duration-300 ease-in-out border-l border-white/5 flex flex-col ${isOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                    
                    <div className="p-4 border-b border-white/5 flex items-center justify-between">
                    <h2 className="text-xl font-bold text-calculator-text">History</h2>
                    <div className="flex gap-2">
                        <button 
                        onClick={handleExport}
                        disabled={history.length === 0}
                        className="p-2 text-calculator-secondaryText hover:text-calculator-accent transition-colors disabled:opacity-50"
                        title="Export CSV"
                        >
                        <IconDownload size={20} />
                        </button>
                        <button 
                        onClick={onClearHistory}
                        disabled={history.length === 0}
                        className="p-2 text-calculator-secondaryText hover:text-red-400 transition-colors disabled:opacity-50"
                        title="Clear All"
                        >
                        <IconTrash size={20} />
                        </button>
                        <button 
                        onClick={onClose}
                        className="p-2 text-calculator-secondaryText hover:text-white transition-colors md:hidden"
                        >
                        <IconX size={20} />
                        </button>
                    </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                    {history.length === 0 ? (
                        <div className="flex flex-col items-center justify-center h-full text-calculator-secondaryText opacity-50">
                        <span className="text-sm">No history yet</span>
                        </div>
                    ) : (
                        history.map((item) => (
                        <div 
                            key={item.id}
                            onClick={() => onSelectHistory(item)}
                            className="group p-3 rounded-lg bg-calculator-bg/50 border border-white/5 hover:border-calculator-accent/30 hover:bg-calculator-bg cursor-pointer transition-all"
                        >
                            <div className="flex justify-between items-start mb-1">
                            <span className="text-calculator-secondaryText text-sm font-mono truncate mr-2">{item.expression}</span>
                            <button 
                                onClick={(e) => handleCopy(e, item.result)}
                                className="text-calculator-secondaryText opacity-0 group-hover:opacity-100 hover:text-calculator-accent transition-opacity"
                                title="Copy Result"
                            >
                                <IconCopy size={14} />
                            </button>
                            </div>
                            <div className="text-right text-calculator-text font-medium text-lg font-mono">= {item.result}</div>
                        </div>
                        ))
                    )}
                    </div>
                </div>
                </React.Fragment>
            );
        };

        // Keypad.tsx
        const Keypad = ({ onInput, onClear, onDelete, onCalculate, mode }) => {
            
            const handleFunc = (func) => onInput(`${func}(`);

            const renderScientificKeys = () => (
                <div className="grid grid-cols-4 gap-3">
                <Button label="sin" variant="function" onClick={() => handleFunc('sin')} />
                <Button label="cos" variant="function" onClick={() => handleFunc('cos')} />
                <Button label="tan" variant="function" onClick={() => handleFunc('tan')} />
                <Button label="log" variant="function" onClick={() => handleFunc('log')} title="Common Log (base 10)" />

                <Button label={<span>sin<sup>-1</sup></span>} variant="function" onClick={() => handleFunc('asin')} title="Inverse Sine" />
                <Button label={<span>cos<sup>-1</sup></span>} variant="function" onClick={() => handleFunc('acos')} title="Inverse Cosine" />
                <Button label={<span>tan<sup>-1</sup></span>} variant="function" onClick={() => handleFunc('atan')} title="Inverse Tangent" />
                <Button label="ln" variant="function" onClick={() => handleFunc('ln')} title="Natural Log" />

                <Button label="(" variant="function" onClick={() => onInput('(')} />
                <Button label=")" variant="function" onClick={() => onInput(')')} />
                <Button label="^" variant="function" onClick={() => onInput('^')} title="Power" />
                <Button label="√" variant="function" onClick={() => handleFunc('sqrt')} title="Square Root" />

                <Button label="!" variant="function" onClick={() => onInput('!')} title="Factorial" />
                <Button label="π" variant="function" onClick={() => onInput('pi')} />
                <Button label="e" variant="function" onClick={() => onInput('e')} title="Euler's Number" />
                <Button label="n√" variant="function" onClick={() => handleFunc('nthRoot')} title="nth Root (root, val)" />

                <Button label="EE" variant="function" onClick={() => onInput('E')} title="Exponential Notation (x10^)" />
                <Button label={<span>x<sup>2</sup></span>} variant="function" onClick={() => onInput('^2')} title="Square" />
                <Button label="1/x" variant="function" onClick={() => onInput('^(-1)')} title="Reciprocal" />
                <Button label="|x|" variant="function" onClick={() => handleFunc('abs')} title="Absolute Value" />
                </div>
            );

            const renderStandardKeys = () => (
                <div className="grid grid-cols-4 gap-3">
                <Button label="C" variant="danger" onClick={onClear} />
                <Button label={<IconDelete size={20}/>} variant="function" onClick={onDelete} />
                <Button label="%" variant="function" onClick={() => onInput('%')} />
                <Button label="÷" variant="operator" onClick={() => onInput('/')} />

                <Button label="7" onClick={() => onInput('7')} />
                <Button label="8" onClick={() => onInput('8')} />
                <Button label="9" onClick={() => onInput('9')} />
                <Button label="×" variant="operator" onClick={() => onInput('*')} />

                <Button label="4" onClick={() => onInput('4')} />
                <Button label="5" onClick={() => onInput('5')} />
                <Button label="6" onClick={() => onInput('6')} />
                <Button label="-" variant="operator" onClick={() => onInput('-')} />

                <Button label="1" onClick={() => onInput('1')} />
                <Button label="2" onClick={() => onInput('2')} />
                <Button label="3" onClick={() => onInput('3')} />
                <Button label="+" variant="operator" onClick={() => onInput('+')} />

                <Button label="0" onClick={() => onInput('0')} className="col-span-2" />
                <Button label="." onClick={() => onInput('.')} />
                <Button label="=" variant="accent" onClick={onCalculate} />
                </div>
            );

            return (
                <div className={`flex flex-col gap-3 transition-all duration-300 ${mode === CalculatorMode.SCIENTIFIC ? 'md:flex-row' : ''}`}>
                {mode === CalculatorMode.SCIENTIFIC && (
                    <div className="w-full md:w-80 transition-all duration-300 animate-in fade-in slide-in-from-top-4 md:slide-in-from-left-4">
                    {renderScientificKeys()}
                    </div>
                )}
                <div className="w-full">
                    {renderStandardKeys()}
                </div>
                </div>
            );
        };

        // App.tsx
        const App = () => {
            const [input, setInput] = React.useState('');
            const [result, setResult] = React.useState('');
            const [isError, setIsError] = React.useState(false);
            const [mode, setMode] = React.useState(CalculatorMode.BASIC);
            const [history, setHistory] = React.useState([]);
            const [isHistoryOpen, setIsHistoryOpen] = React.useState(false);

            const handleKeyDown = React.useCallback((e) => {
                const key = e.key;
                
                if (/^[0-9+\-*/%.^()]$/.test(key)) {
                e.preventDefault();
                setInput(prev => prev + key);
                }
                
                if (key === 'Enter') {
                e.preventDefault();
                calculateResult();
                }
                
                if (key === 'Backspace') {
                e.preventDefault();
                handleDelete();
                }
                
                if (key === 'Escape') {
                e.preventDefault();
                handleClear();
                }
            }, [input]);

            React.useEffect(() => {
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [handleKeyDown]);

            const handleInput = (val) => {
                if (val === '.' && input.slice(-1) === '.') return;
                
                if (isError) {
                setIsError(false);
                setInput(val);
                setResult('');
                return;
                }

                setInput(prev => prev + val);
            };

            const handleDelete = () => {
                if (isError) {
                handleClear();
                return;
                }
                setInput(prev => prev.slice(0, -1));
                setResult('');
            };

            const handleClear = () => {
                setInput('');
                setResult('');
                setIsError(false);
            };

            const calculateResult = () => {
                if (!input) return;

                const calcResult = evaluateExpression(input);

                if (calcResult === "Error") {
                setIsError(true);
                setResult("Error");
                } else {
                setResult(calcResult);
                setIsError(false);
                
                const newItem = {
                    id: generateId(),
                    expression: input,
                    result: calcResult,
                    timestamp: Date.now()
                };
                setHistory(prev => [newItem, ...prev]);
                }
            };

            const handleHistorySelect = (item) => {
                setInput(item.expression);
                setResult(item.result);
                setIsError(false);
                if (window.innerWidth < 768) {
                setIsHistoryOpen(false);
                }
            };

            const toggleMode = () => {
                setMode(prev => prev === CalculatorMode.BASIC ? CalculatorMode.SCIENTIFIC : CalculatorMode.BASIC);
            };

            return (
                <div className="min-h-screen bg-calculator-bg flex items-center justify-center p-4 md:p-8 relative font-sans">
                
                <div className={`w-full flex flex-col gap-6 relative z-10 transition-all duration-500 ease-in-out ${mode === CalculatorMode.SCIENTIFIC ? 'max-w-4xl' : 'max-w-sm'}`}>
                    
                    <div className="flex justify-between items-center bg-calculator-surface/50 p-2 rounded-2xl border border-white/5 backdrop-blur-md">
                    <div className="flex gap-2">
                        <button 
                        onClick={toggleMode}
                        className={`flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium transition-all ${mode === CalculatorMode.BASIC ? 'bg-calculator-accent text-calculator-bg shadow-lg shadow-calculator-accent/20' : 'text-calculator-secondaryText hover:text-white hover:bg-white/5'}`}
                        >
                        <IconCalculator size={16} />
                        <span className="hidden md:inline">Basic</span>
                        </button>
                        <button 
                        onClick={toggleMode}
                        className={`flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium transition-all ${mode === CalculatorMode.SCIENTIFIC ? 'bg-calculator-function text-calculator-bg shadow-lg shadow-calculator-function/20' : 'text-calculator-secondaryText hover:text-white hover:bg-white/5'}`}
                        >
                        <IconFlask size={16} />
                        <span className="hidden md:inline">Scientific</span>
                        </button>
                    </div>

                    <div className="flex gap-2">
                        <button 
                        onClick={() => setIsHistoryOpen(true)}
                        className="p-3 text-calculator-text hover:bg-white/10 rounded-xl transition-colors relative"
                        title="History"
                        >
                        <IconHistory size={20} />
                        {history.length > 0 && (
                            <span className="absolute top-2 right-2 w-2 h-2 bg-calculator-accent rounded-full animate-pulse"></span>
                        )}
                        </button>
                    </div>
                    </div>

                    <div className="bg-calculator-surface p-6 rounded-3xl shadow-2xl border border-white/5 flex flex-col gap-4">
                        <Display input={input} result={result} isError={isError} />
                        <Keypad 
                        mode={mode}
                        onInput={handleInput}
                        onClear={handleClear}
                        onDelete={handleDelete}
                        onCalculate={calculateResult}
                        />
                    </div>

                    <div className="text-center text-calculator-secondaryText/40 text-xs font-mono">
                    OmniCalc Pro v1.0
                    </div>
                </div>

                <HistoryPanel 
                    isOpen={isHistoryOpen} 
                    onClose={() => setIsHistoryOpen(false)}
                    history={history}
                    onSelectHistory={handleHistorySelect}
                    onClearHistory={() => setHistory([])}
                />

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <React.StrictMode>
                <App />
            </React.StrictMode>
        );
    </script>
</body>
</html>